{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/streaks.css' %}?v={% now 'U' %}">
<style>
    /* Streak Specific Styles */
    .streak-display {
        position: relative;
    }

    .streak-flame {
        position: relative;
        display: inline-block;
    }

    .streak-icon {
        color: #FF5722;
        filter: drop-shadow(0 0 5px rgba(255, 87, 34, 0.7));
        animation: flamePulse 2s infinite alternate;
    }

    .streak-count {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 0.8em;
        text-shadow: 0 0 3px #000;
    }

    @keyframes flamePulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding-left: 1rem;
    }
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    .timeline-item:before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 2px;
        height: 100%;
        background: var(--primary-color);
        opacity: 0.3;
    }
    .timeline-days {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .timeline-day {
        background: rgba(255,255,255,0.1);
        border-radius: 0.5rem;
        padding: 0.5rem;
        text-align: center;
        min-width: 60px;
    }
    .timeline-day.active {
        background: var(--primary-color);
        color: white;
    }
    .timeline-day .day-icon {
        font-size: 1.2rem;
        margin: 0.3rem 0;
    }
    .timeline-day .day-foods {
        display: flex;
        flex-wrap: wrap;
        gap: 0.2rem;
        justify-content: center;
    }

    /* Achievement Cards */
    .achievement-card {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 0.5rem;
        background: rgba(255,255,255,0.05);
        height: 100%;
    }
    .achievement-card.unlocked {
        background: rgba(67, 97, 238, 0.1);
        border-left: 3px solid var(--primary-color);
    }
    .achievement-card.locked {
        opacity: 0.6;
    }
    .achievement-icon {
        font-size: 2rem;
        width: 60px;
        text-align: center;
    }
    .achievement-card.unlocked .achievement-icon {
        color: var(--primary-color);
    }
    .achievement-card.locked .achievement-icon {
        color: #666;
    }
    .achievement-details {
        flex: 1;
    }
    .achievement-details h5 {
        margin-bottom: 0.3rem;
    }
    .achievement-details p {
        margin-bottom: 0;
        font-size: 0.9rem;
        color: #aaa;
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .streak-icon {
        filter: drop-shadow(0 0 5px rgba(255, 87, 34, 0.9));
    }
    [data-theme="dark"] .timeline-day {
        background: rgba(0,0,0,0.2);
    }
    [data-theme="dark"] .achievement-card {
        background: rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block body %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Streak Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="streakTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" 
                            data-bs-target="#dashboard" type="button" role="tab">
                        <i class="fas fa-fire me-2"></i>Dashboard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" 
                            data-bs-target="#history" type="button" role="tab">
                        <i class="fas fa-history me-2"></i>History
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="achievements-tab" data-bs-toggle="tab" 
                            data-bs-target="#achievements" type="button" role="tab">
                        <i class="fas fa-trophy me-2"></i>Achievements
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="streakTabsContent">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <div class="card bg-secondary mb-4">
                        <div class="card-header">
                            <h3 class="mb-0">🔥 Your Streak Dashboard</h3>
                        </div>
                        <div class="card-body text-center">
                            <div class="streak-display mb-4">
                                <div class="d-flex justify-content-center align-items-center">
                                    <div class="streak-flame mx-3" style="font-size: 3rem;">
                                        <i class="fas fa-fire streak-icon"></i>
                                        <div class="streak-count">{{ current_streak }}</div>
                                    </div>
                                    <div>
                                        <h2 class="mb-0">{{ current_streak }} day streak</h2>
                                        <small class="text-muted">Longest: {{ longest_streak }} days</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress to next milestone -->
                            <div class="mb-4">
                                <h5>Progress to next milestone ({{ next_milestone }} days)</h5>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar progress-bar-striped bg-warning" role="progressbar" 
                                         style="width: {{ progress }}%" aria-valuenow="{{ progress }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        {{ progress }}%
                                    </div>
                                </div>
                            </div>

                            <!-- Last active -->
                            <div class="alert alert-info">
                                <i class="fas fa-calendar-day me-2"></i>
                                Last active: {{ last_active|date:"F j, Y" }}
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card bg-secondary">
                        <div class="card-header">
                            <h4 class="mb-0">📅 Recent Activity</h4>
                        </div>
                        <div class="card-body">
                            {% if recent_logs %}
                            <div class="list-group">
                                {% for log in recent_logs %}
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ log.food_consumed.food_name }}</h5>
                                        <small>{{ log.consumed_at|timesince }} ago</small>
                                    </div>
                                    <p class="mb-1">
                                        <span class="badge bg-primary">{{ log.food_consumed.calories }} cal</span>
                                        <span class="badge bg-success">{{ log.food_consumed.protein }}g protein</span>
                                    </p>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-utensils fa-3x mb-3 text-muted"></i>
                                <p class="lead">No recent activity found</p>
                                <a href="{% url 'food_log' %}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Log Food
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-pane fade" id="history" role="tabpanel">
                    <div class="card bg-secondary">
                        <div class="card-header">
                            <h3 class="mb-0">📅 Your Streak History</h3>
                        </div>
                        <div class="card-body">
                            <!-- Timeline -->
                            <div class="timeline">
                                {% for week, logs in weekly_logs.items %}
                                <div class="timeline-item mb-4">
                                    <div class="timeline-header d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">Week {{ week }}</h5>
                                        <span class="badge bg-primary">{{ logs|length }} logs</span>
                                    </div>
                                    
                                    <div class="timeline-days">
                                        {% for day in logs|slice:":7" %}
                                        <div class="timeline-day {% if forloop.first %}active{% endif %}">
                                            <div class="day-date">{{ day.consumed_at|date:"D" }}</div>
                                            <div class="day-icon">
                                                <i class="fas fa-{% if forloop.first %}fire{% else %}check{% endif %}"></i>
                                            </div>
                                            <div class="day-foods">
                                                {% for food in logs|slice:":3" %}
                                                <span class="badge bg-secondary">{{ food.food_consumed.food_name }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center py-4">
                                    <i class="fas fa-history fa-3x mb-3 text-muted"></i>
                                    <p class="lead">No streak history yet</p>
                                    <p>Start logging your food to build your streak!</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Achievements Tab -->
                <div class="tab-pane fade" id="achievements" role="tabpanel">
                    <div class="card bg-secondary">
                        <div class="card-header">
                            <h3 class="mb-0">🏆 Your Achievements</h3>
                        </div>
                        <div class="card-body">
                            <!-- Current Status -->
                            <div class="text-center mb-4">
                                <div class="streak-flame d-inline-block mx-3" style="font-size: 2.5rem;">
                                    <i class="fas fa-fire streak-icon"></i>
                                    <div class="streak-count">{{ current_streak }}</div>
                                </div>
                                <h4>Current Streak: {{ current_streak }} days</h4>
                                <p class="text-muted">Longest Streak: {{ longest_streak }} days</p>
                            </div>

                            <!-- Milestones -->
                            <h4 class="mb-3">Milestones</h4>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="achievement-card {% if milestones.5_days %}unlocked{% else %}locked{% endif %}">
                                        <div class="achievement-icon">
                                            <i class="fas fa-{% if milestones.5_days %}trophy{% else %}lock{% endif %}"></i>
                                        </div>
                                        <div class="achievement-details">
                                            <h5>5-Day Streak</h5>
                                            <p>Log food for 5 consecutive days</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="achievement-card {% if milestones.10_days %}unlocked{% else %}locked{% endif %}">
                                        <div class="achievement-icon">
                                            <i class="fas fa-{% if milestones.10_days %}trophy{% else %}lock{% endif %}"></i>
                                        </div>
                                        <div class="achievement-details">
                                            <h5>10-Day Streak</h5>
                                            <p>Double digits! Keep going!</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="achievement-card {% if milestones.30_days %}unlocked{% else %}locked{% endif %}">
                                        <div class="achievement-icon">
                                            <i class="fas fa-{% if milestones.30_days %}trophy{% else %}lock{% endif %}"></i>
                                        </div>
                                        <div class="achievement-details">
                                            <h5>30-Day Master</h5>
                                            <p>A full month of consistency</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="achievement-card {% if milestones.100_days %}unlocked{% else %}locked{% endif %}">
                                        <div class="achievement-icon">
                                            <i class="fas fa-{% if milestones.100_days %}trophy{% else %}lock{% endif %}"></i>
                                        </div>
                                        <div class="achievement-details">
                                            <h5>100-Day Legend</h5>
                                            <p>Join the elite 100-day club</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confetti Canvas (hidden until triggered) -->
<canvas id="confetti" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;pointer-events:none;display:none;"></canvas>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tab functionality
    const streakTabs = document.getElementById('streakTabs');
    if (streakTabs) {
        streakTabs.addEventListener('shown.bs.tab', function (event) {
            // Handle tab changes if needed
        });
    }

    // Get streak data from DOM
    const flame = document.querySelector('.streak-flame');
    const currentStreak = parseInt(document.querySelector('.streak-count').textContent);
    
    if (flame && currentStreak > 0) {
        flame.classList.add('animate__animated', 'animate__pulse');
        
        // Special celebration for milestones
        if (currentStreak % 5 === 0) {
            flame.classList.add('text-warning');
            setTimeout(() => {
                const confettiSettings = {
                    target: 'confetti',
                    max: 80,
                    size: 1.5,
                    animate: true,
                    props: ['circle', 'square', 'triangle', 'line'],
                    colors: [
                        [67, 97, 238],  // Primary color
                        [76, 201, 240], // Accent color
                        [255, 87, 34],  // Flame color
                        [255, 215, 0]   // Gold
                    ]
                };
                const confetti = new ConfettiGenerator(confettiSettings);
                confetti.render();
                
                document.getElementById('confetti').style.display = 'block';
                
                setTimeout(() => {
                    confetti.clear();
                    document.getElementById('confetti').style.display = 'none';
                }, 3000);
            }, 500);
        }
    }
});
</script>
{% endblock %}